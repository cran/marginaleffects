<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Comparisons to alternative software</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Comparisons to alternative software</h1>



<p>If you do not like <code>marginaleffects</code>, you may want to consider one of the alternatives described below:</p>
<ul>
<li><code>margins</code>: <a href="https://cran.r-project.org/web/packages/margins/index.html" class="uri">https://cran.r-project.org/web/packages/margins/index.html</a></li>
<li><code>prediction</code>: <a href="https://cran.r-project.org/web/packages/prediction/index.html" class="uri">https://cran.r-project.org/web/packages/prediction/index.html</a></li>
<li><code>emmeans</code>: <a href="https://cran.r-project.org/web/packages/emmeans/index.html" class="uri">https://cran.r-project.org/web/packages/emmeans/index.html</a></li>
<li><code>brmsmargins</code>: <a href="https://joshuawiley.com/brmsmargins/" class="uri">https://joshuawiley.com/brmsmargins/</a></li>
<li><code>effects</code>: <a href="https://cran.r-project.org/web/packages/effects/index.html" class="uri">https://cran.r-project.org/web/packages/effects/index.html</a></li>
<li><code>modelbased</code>: <a href="https://easystats.github.io/modelbased/" class="uri">https://easystats.github.io/modelbased/</a></li>
<li><code>ggeffects</code>: <a href="https://strengejacke.github.io/ggeffects/" class="uri">https://strengejacke.github.io/ggeffects/</a></li>
<li><code>Stata</code> by StataCorp LLC</li>
</ul>
<div id="emmeans" class="section level1">
<h1><code>emmeans</code></h1>
<p>The <a href="https://cran.r-project.org/web/packages/emmeans/index.html"><code>emmeans</code> package</a> is developed by Russell V. Lenth and colleagues. It is an extremely powerful package which focuses on the computation of marginal means, but which can also compute slopes.</p>
<p>In my (Vincent’s) biased opinion, the main benefits of <code>marginaleffects</code> over <code>emmeans</code>:</p>
<ul>
<li>Support more model types.</li>
<li>Simpler and more intuitive user interface.</li>
<li>Easier to compute average marginal effects and unit-level marginal effects for whole datasets.</li>
<li>Easier to compute marginal effects (slopes) for custom grids and continuous regressors.</li>
<li>Common plots are easy with the <code>plot_cap()</code> and <code>plot_cme()</code> functions.</li>
</ul>
<p>Many of <code>marginaleffects</code> advantages come down to subjective preferences over user interface. Readers are thus encouraged to try both packages to see which interface they prefer. Please keep in mind that <code>emmeans</code> offers many features which are not yet available in <code>marginaleffects</code>, including:</p>
<ul>
<li>Transformations and link functions
<ul>
<li><code>marginaleffects</code> can compute quantities on different scales with the <code>type</code> argument, but <code>emmeans</code> offers a richer array of possibilities for back transforms.</li>
</ul></li>
<li>Custom contrasts and linear functions
<ul>
<li>Compare to the <code>contrast_factor</code> and <code>contrast_numeric</code> arguments of the <code>marginaleffects::comparisons</code> function.</li>
</ul></li>
<li>Multiplicity adjustments.</li>
<li>Joint tests.</li>
<li>Equivalence tests.</li>
<li>Various plots.</li>
</ul>
<p>The <a href="https://vincentarelbundock.github.io/marginaleffects/articles/mfx04_marginalmeans.html">Marginal Means Vignette</a> includes side-by-side comparisons of <code>emmeans</code> and <code>marginaleffects</code> to compute marginal means. The rest of this section compares the syntax for contrasts and marginaleffects.</p>
<div id="contrasts" class="section level2">
<h2>Contrasts</h2>
<p>AFAICT, <code>emmeans</code> does not provide an easy way to compute unit-level contrasts for every row of the dataset used to fit our model. Therefore, the side-by-side syntax shown below will always include <code>newdata=datagrid()</code> to specify that we want to compute only one contrast: at the mean values of the regressors. In day-to-day practice with <code>marginaleffects()</code>, however, this extra argument would not be necessary.</p>
<p>Fit a model:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(emmeans)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(marginaleffects)</a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4">mod &lt;-<span class="st"> </span><span class="kw">glm</span>(vs <span class="op">~</span><span class="st"> </span>hp <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(cyl), <span class="dt">data =</span> mtcars, <span class="dt">family =</span> binomial)</a></code></pre></div>
<p>Response scale, reference groups:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">emm &lt;-<span class="st"> </span><span class="kw">emmeans</span>(mod, <span class="dt">specs =</span> <span class="st">&quot;cyl&quot;</span>, <span class="dt">regrid =</span> <span class="st">&quot;response&quot;</span>)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">contrast</span>(emm, <span class="dt">method =</span> <span class="st">&quot;trt.vs.ctrl1&quot;</span>)</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="co">#&gt;  contrast estimate    SE  df z.ratio p.value</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="co">#&gt;  6 - 4      -0.222 0.394 Inf  -0.564  0.7842</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="co">#&gt;  8 - 4      -0.595 0.511 Inf  -1.163  0.4049</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="co">#&gt; P value adjustment: dunnettx method for 2 tests</span></a>
<a class="sourceLine" id="cb2-8" title="8"></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="kw">comparisons</span>(mod, <span class="dt">newdata =</span> <span class="kw">datagrid</span>())</a>
<a class="sourceLine" id="cb2-10" title="10"><span class="co">#&gt;   rowid     type term contrast    comparison    std.error   statistic   p.value      conf.low</span></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="co">#&gt; 1     1 response   hp       +1 -1.557824e-10 6.803615e-07 -0.00022897 0.9998173 -1.333640e-06</span></a>
<a class="sourceLine" id="cb2-12" title="12"><span class="co">#&gt; 2     1 response  cyl    6 - 4 -2.221851e-01 3.916435e-01 -0.56731461 0.5705005 -9.897921e-01</span></a>
<a class="sourceLine" id="cb2-13" title="13"><span class="co">#&gt; 3     1 response  cyl    8 - 4 -5.946855e-01 5.097420e-01 -1.16664014 0.2433557 -1.593761e+00</span></a>
<a class="sourceLine" id="cb2-14" title="14"><span class="co">#&gt;      conf.high       hp cyl</span></a>
<a class="sourceLine" id="cb2-15" title="15"><span class="co">#&gt; 1 1.333328e-06 146.6875   8</span></a>
<a class="sourceLine" id="cb2-16" title="16"><span class="co">#&gt; 2 5.454220e-01 146.6875   8</span></a>
<a class="sourceLine" id="cb2-17" title="17"><span class="co">#&gt; 3 4.043905e-01 146.6875   8</span></a></code></pre></div>
<p>Link scale, pairwise contrasts:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">emm &lt;-<span class="st"> </span><span class="kw">emmeans</span>(mod, <span class="dt">specs =</span> <span class="st">&quot;cyl&quot;</span>)</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">contrast</span>(emm, <span class="dt">method =</span> <span class="st">&quot;revpairwise&quot;</span>)</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co">#&gt;  contrast estimate      SE  df z.ratio p.value</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">#&gt;  6 - 4      -0.905    1.63 Inf  -0.555  0.8439</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">#&gt;  8 - 4     -19.542 4367.17 Inf  -0.004  1.0000</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co">#&gt;  8 - 6     -18.637 4367.16 Inf  -0.004  1.0000</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co">#&gt; Results are given on the log odds ratio (not the response) scale. </span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co">#&gt; P value adjustment: tukey method for comparing a family of 3 estimates</span></a>
<a class="sourceLine" id="cb3-10" title="10"></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="kw">comparisons</span>(mod,</a>
<a class="sourceLine" id="cb3-12" title="12">            <span class="dt">type =</span> <span class="st">&quot;link&quot;</span>,</a>
<a class="sourceLine" id="cb3-13" title="13">            <span class="dt">newdata =</span> <span class="kw">datagrid</span>(),</a>
<a class="sourceLine" id="cb3-14" title="14">            <span class="dt">contrast_factor =</span> <span class="st">&quot;pairwise&quot;</span>)</a>
<a class="sourceLine" id="cb3-15" title="15"><span class="co">#&gt;   rowid type term contrast   comparison    std.error    statistic   p.value      conf.low</span></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="co">#&gt; 1     1 link   hp       +1  -0.03257475 3.388105e-02 -0.961444596 0.3363287 -9.898038e-02</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="co">#&gt; 2     1 link  cyl    6 - 4  -0.90487411 1.630231e+00 -0.555058785 0.5788545 -4.100068e+00</span></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="co">#&gt; 3     1 link  cyl    8 - 4 -19.54175662 4.367166e+03 -0.004474700 0.9964297 -8.579030e+03</span></a>
<a class="sourceLine" id="cb3-19" title="19"><span class="co">#&gt; 4     1 link  cyl    8 - 6 -18.63688250 4.367165e+03 -0.004267501 0.9965950 -8.578124e+03</span></a>
<a class="sourceLine" id="cb3-20" title="20"><span class="co">#&gt;      conf.high       hp cyl</span></a>
<a class="sourceLine" id="cb3-21" title="21"><span class="co">#&gt; 1 3.383088e-02 146.6875   8</span></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="co">#&gt; 2 2.290320e+00 146.6875   8</span></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="co">#&gt; 3 8.539946e+03 146.6875   8</span></a>
<a class="sourceLine" id="cb3-24" title="24"><span class="co">#&gt; 4 8.540850e+03 146.6875   8</span></a></code></pre></div>
</div>
<div id="contrasts-by-group" class="section level2">
<h2>Contrasts by group</h2>
<p>Here is a slightly more complicated example with contrasts estimated by subgroup in a <code>glmmTMB</code> mixed effects model. First we estimate a model and compute pairwise contrasts by subgroup using <code>emmeans</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">library</span>(glmmTMB)</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">library</span>(emmeans)</a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;https://vincentarelbundock.github.io/Rdatasets/csv/lme4/VerbAgg.csv&quot;</span>)</a>
<a class="sourceLine" id="cb4-6" title="6">dat<span class="op">$</span>woman &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(dat<span class="op">$</span>Gender <span class="op">==</span><span class="st"> &quot;F&quot;</span>)</a>
<a class="sourceLine" id="cb4-7" title="7"></a>
<a class="sourceLine" id="cb4-8" title="8">mod &lt;-<span class="st"> </span><span class="kw">glmmTMB</span>(</a>
<a class="sourceLine" id="cb4-9" title="9">    woman <span class="op">~</span><span class="st"> </span>btype <span class="op">*</span><span class="st"> </span>resp <span class="op">+</span><span class="st"> </span>situ <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>Anger <span class="op">|</span><span class="st"> </span>item),</a>
<a class="sourceLine" id="cb4-10" title="10">    <span class="dt">family =</span> binomial,</a>
<a class="sourceLine" id="cb4-11" title="11">    <span class="dt">data =</span> dat)</a>
<a class="sourceLine" id="cb4-12" title="12"></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="kw">emmeans</span>(mod, <span class="dt">specs =</span> <span class="st">&quot;btype&quot;</span>, <span class="dt">by =</span> <span class="st">&quot;resp&quot;</span>) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="st">    </span><span class="kw">contrast</span>(<span class="dt">method =</span> <span class="st">&quot;revpairwise&quot;</span>, <span class="dt">adjust =</span> <span class="st">&quot;none&quot;</span>)</a>
<a class="sourceLine" id="cb4-15" title="15"><span class="co">#&gt; resp = no:</span></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="co">#&gt;  contrast      estimate     SE   df t.ratio p.value</span></a>
<a class="sourceLine" id="cb4-17" title="17"><span class="co">#&gt;  scold - curse  -0.0152 0.1097 7571  -0.139  0.8898</span></a>
<a class="sourceLine" id="cb4-18" title="18"><span class="co">#&gt;  shout - curse  -0.2533 0.1022 7571  -2.479  0.0132</span></a>
<a class="sourceLine" id="cb4-19" title="19"><span class="co">#&gt;  shout - scold  -0.2381 0.0886 7571  -2.686  0.0072</span></a>
<a class="sourceLine" id="cb4-20" title="20"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-21" title="21"><span class="co">#&gt; resp = perhaps:</span></a>
<a class="sourceLine" id="cb4-22" title="22"><span class="co">#&gt;  contrast      estimate     SE   df t.ratio p.value</span></a>
<a class="sourceLine" id="cb4-23" title="23"><span class="co">#&gt;  scold - curse  -0.2393 0.1178 7571  -2.031  0.0423</span></a>
<a class="sourceLine" id="cb4-24" title="24"><span class="co">#&gt;  shout - curse  -0.0834 0.1330 7571  -0.627  0.5309</span></a>
<a class="sourceLine" id="cb4-25" title="25"><span class="co">#&gt;  shout - scold   0.1559 0.1358 7571   1.148  0.2511</span></a>
<a class="sourceLine" id="cb4-26" title="26"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-27" title="27"><span class="co">#&gt; resp = yes:</span></a>
<a class="sourceLine" id="cb4-28" title="28"><span class="co">#&gt;  contrast      estimate     SE   df t.ratio p.value</span></a>
<a class="sourceLine" id="cb4-29" title="29"><span class="co">#&gt;  scold - curse   0.0391 0.1292 7571   0.302  0.7624</span></a>
<a class="sourceLine" id="cb4-30" title="30"><span class="co">#&gt;  shout - curse   0.5802 0.1784 7571   3.252  0.0012</span></a>
<a class="sourceLine" id="cb4-31" title="31"><span class="co">#&gt;  shout - scold   0.5411 0.1888 7571   2.866  0.0042</span></a>
<a class="sourceLine" id="cb4-32" title="32"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-33" title="33"><span class="co">#&gt; Results are averaged over the levels of: situ </span></a>
<a class="sourceLine" id="cb4-34" title="34"><span class="co">#&gt; Results are given on the log odds ratio (not the response) scale.</span></a></code></pre></div>
<p>What did <code>emmeans</code> do to obtain these results? Roughly speaking:</p>
<ol style="list-style-type: decimal">
<li>Create a prediction grid with one cell for each combination of categorical predictor in the model.</li>
<li>Make adjusted predictions in each cell of the prediction grid.</li>
<li>Take the average of those predictions (marginal means) for each combination of <code>btype</code> and <code>resp</code>, the focal variable, and the group variable specified in the <code>by</code> argument.</li>
<li>Compute pairwise differences (contrasts) in marginal means across different levels of the focal variable <code>btype</code>.</li>
</ol>
<p>In short, <code>emmeans</code> computes pairwise contrasts <em>between marginal means</em>. This is different from the default types of contrasts produced by <code>comparisons()</code>, which does <em>not</em> average across a pre-specified grid of predictors. What does <code>comparisons()</code> do instead?</p>
<p>Let <code>newdata</code> be a data frame supplied by the user (or the original data frame used to fit the model), then:</p>
<ol style="list-style-type: decimal">
<li>Create a new data frame called <code>newdata2</code>, which is identical to <code>newdata</code> except that the focal variable is incremented by one level.</li>
<li>Compute contrasts as the difference between adjusted predictions made on the two datasets:
<ul>
<li><code>predict(model, newdata = newdata2) - predict(model, newdata = newdata)</code></li>
</ul></li>
</ol>
<p>Although it is not idiomatic, we can use still use <code>comparisons()</code> to emulate the <code>emmeans</code> results. First, we create a prediction grid with one cell for each combination of categorical predictor in the model:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">nd &lt;-<span class="st"> </span><span class="kw">datagrid</span>(</a>
<a class="sourceLine" id="cb5-2" title="2">    <span class="dt">model =</span> mod,</a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="dt">resp =</span> dat<span class="op">$</span>resp,</a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="dt">situ =</span> dat<span class="op">$</span>situ,</a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="dt">btype =</span> dat<span class="op">$</span>btype)</a>
<a class="sourceLine" id="cb5-6" title="6"><span class="kw">nrow</span>(nd)</a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co">#&gt; [1] 18</span></a></code></pre></div>
<p>This grid has 18 rows, one for each combination of levels for the <code>resp</code> (3), <code>situ</code> (2), and <code>btype</code> (3) variables (3 * 2 * 3 = 18).</p>
<p>Then we compute pairwise contrasts over this grid:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">cmp &lt;-<span class="st"> </span><span class="kw">comparisons</span>(mod,</a>
<a class="sourceLine" id="cb6-2" title="2">    <span class="dt">variables =</span> <span class="st">&quot;btype&quot;</span>,</a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="dt">newdata =</span> nd,</a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="dt">contrast_factor =</span> <span class="st">&quot;pairwise&quot;</span>,</a>
<a class="sourceLine" id="cb6-5" title="5">    <span class="dt">type =</span> <span class="st">&quot;link&quot;</span>)</a>
<a class="sourceLine" id="cb6-6" title="6"><span class="kw">nrow</span>(cmp)</a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co">#&gt; [1] 54</span></a></code></pre></div>
<p>There are 3 pairwise contrasts, corresponding to the 3 pairwise comparisons possible between the 3 levels of the focal variable <code>btype</code>: <code>scold-curse</code>, <code>shout-scold</code>, <code>shout-curse</code>. The <code>comparisons()</code> estimates contrasts for each row of <code>newdata</code>, so we get <span class="math inline">\(18 \times 3 = 54\)</span> rows.</p>
<p>Finally, we wanted contrasts for each subgroup of the <code>resp</code> variable, so we average out the contrasts using the <code>summary()</code> and the <code>by</code> argument:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">cmp <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">summary</span>(<span class="dt">by =</span> <span class="st">&quot;resp&quot;</span>)</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="co">#&gt; Average contrasts </span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co">#&gt;    Term      Contrast    resp   Effect Std. Error z value  Pr(&gt;|z|)   2.5 %    97.5 %</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="co">#&gt; 1 btype scold - curse      no -0.01520    0.10965 -0.1386 0.8897595 -0.2301  0.199718</span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="co">#&gt; 2 btype scold - curse perhaps -0.23928    0.11779 -2.0314 0.0422153 -0.4701 -0.008414</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="co">#&gt; 3 btype scold - curse     yes  0.03907    0.12922  0.3023 0.7623894 -0.2142  0.292346</span></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="co">#&gt; 4 btype shout - curse      no -0.25330    0.10220 -2.4785 0.0131918 -0.4536 -0.052997</span></a>
<a class="sourceLine" id="cb7-8" title="8"><span class="co">#&gt; 5 btype shout - curse perhaps -0.08336    0.13303 -0.6266 0.5309122 -0.3441  0.177377</span></a>
<a class="sourceLine" id="cb7-9" title="9"><span class="co">#&gt; 6 btype shout - curse     yes  0.58018    0.17842  3.2518 0.0011469  0.2305  0.929876</span></a>
<a class="sourceLine" id="cb7-10" title="10"><span class="co">#&gt; 7 btype shout - scold      no -0.23810    0.08864 -2.6860 0.0072315 -0.4118 -0.064358</span></a>
<a class="sourceLine" id="cb7-11" title="11"><span class="co">#&gt; 8 btype shout - scold perhaps  0.15592    0.13584  1.1479 0.2510290 -0.1103  0.422152</span></a>
<a class="sourceLine" id="cb7-12" title="12"><span class="co">#&gt; 9 btype shout - scold     yes  0.54111    0.18881  2.8659 0.0041576  0.1711  0.911163</span></a>
<a class="sourceLine" id="cb7-13" title="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-14" title="14"><span class="co">#&gt; Model type:  glmmTMB </span></a>
<a class="sourceLine" id="cb7-15" title="15"><span class="co">#&gt; Prediction type:  link</span></a></code></pre></div>
<p>These results are identical to those produced by <code>emmeans</code> (except for <span class="math inline">\(t\)</span> vs. <span class="math inline">\(z\)</span>).</p>
</div>
<div id="marginal-effects" class="section level2">
<h2>Marginal Effects</h2>
<p>AFAICT, <code>emmeans::emtrends</code> makes it easier to compute marginal effects for a few user-specified values than for large grids or for the full original dataset.</p>
<p>Response scale, user-specified values:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">mod &lt;-<span class="st"> </span><span class="kw">glm</span>(vs <span class="op">~</span><span class="st"> </span>hp <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(cyl), <span class="dt">data =</span> mtcars, <span class="dt">family =</span> binomial)</a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="kw">emtrends</span>(mod, <span class="op">~</span>hp, <span class="st">&quot;hp&quot;</span>, <span class="dt">regrid =</span> <span class="st">&quot;response&quot;</span>, <span class="dt">at =</span> <span class="kw">list</span>(<span class="dt">cyl =</span> <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb8-4" title="4"><span class="co">#&gt;   hp hp.trend    SE  df asymp.LCL asymp.UCL</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="co">#&gt;  147 -0.00786 0.011 Inf   -0.0294    0.0137</span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co">#&gt; Confidence level used: 0.95</span></a>
<a class="sourceLine" id="cb8-8" title="8"></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="kw">marginaleffects</span>(mod, <span class="dt">newdata =</span> <span class="kw">datagrid</span>(<span class="dt">cyl =</span> <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb8-10" title="10"><span class="co">#&gt;   rowid     type term contrast         dydx  std.error  statistic   p.value    conf.low</span></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="co">#&gt; 1     1 response   hp    dY/dX -0.007851646 0.01111021 -0.7067055 0.4797495 -0.02962726</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co">#&gt; 2     1 response  cyl    6 - 4 -0.222185055 0.39164346 -0.5673146 0.5705005 -0.98979213</span></a>
<a class="sourceLine" id="cb8-13" title="13"><span class="co">#&gt; 3     1 response  cyl    8 - 4 -0.594685481 0.50974200 -1.1666401 0.2433557 -1.59376144</span></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="co">#&gt;    conf.high       hp cyl</span></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="co">#&gt; 1 0.01392396 146.6875   4</span></a>
<a class="sourceLine" id="cb8-16" title="16"><span class="co">#&gt; 2 0.54542202 146.6875   4</span></a>
<a class="sourceLine" id="cb8-17" title="17"><span class="co">#&gt; 3 0.40439048 146.6875   4</span></a></code></pre></div>
<p>Link scale, user-specified values:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">emtrends</span>(mod, <span class="op">~</span>hp, <span class="st">&quot;hp&quot;</span>, <span class="dt">at =</span> <span class="kw">list</span>(<span class="dt">cyl =</span> <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">#&gt;   hp hp.trend     SE  df asymp.LCL asymp.UCL</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="co">#&gt;  147  -0.0326 0.0339 Inf    -0.099    0.0338</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co">#&gt; Confidence level used: 0.95</span></a>
<a class="sourceLine" id="cb9-6" title="6"></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="kw">marginaleffects</span>(mod, <span class="dt">type =</span> <span class="st">&quot;link&quot;</span>, <span class="dt">newdata =</span> <span class="kw">datagrid</span>(<span class="dt">cyl =</span> <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb9-8" title="8"><span class="co">#&gt;   rowid type term contrast         dydx    std.error  statistic   p.value      conf.low</span></a>
<a class="sourceLine" id="cb9-9" title="9"><span class="co">#&gt; 1     1 link   hp    dY/dX  -0.03257475 3.388105e-02 -0.9614445 0.3363287 -9.898039e-02</span></a>
<a class="sourceLine" id="cb9-10" title="10"><span class="co">#&gt; 2     1 link  cyl    6 - 4  -0.90487411 1.630231e+00 -0.5550588 0.5788545 -4.100068e+00</span></a>
<a class="sourceLine" id="cb9-11" title="11"><span class="co">#&gt; 3     1 link  cyl    8 - 4 -19.54175662 4.367166e+03 -0.0044747 0.9964297 -8.579030e+03</span></a>
<a class="sourceLine" id="cb9-12" title="12"><span class="co">#&gt;      conf.high       hp cyl</span></a>
<a class="sourceLine" id="cb9-13" title="13"><span class="co">#&gt; 1 3.383089e-02 146.6875   4</span></a>
<a class="sourceLine" id="cb9-14" title="14"><span class="co">#&gt; 2 2.290320e+00 146.6875   4</span></a>
<a class="sourceLine" id="cb9-15" title="15"><span class="co">#&gt; 3 8.539946e+03 146.6875   4</span></a></code></pre></div>
</div>
</div>
<div id="margins-and-prediction" class="section level1">
<h1><code>margins</code> and <code>prediction</code></h1>
<p>The <a href="https://cran.r-project.org/web/packages/margins/index.html"><code>margins</code></a> and <a href="https://cran.r-project.org/web/packages/prediction/index.html"><code>prediction</code></a> packages for <code>R</code> were designed by Thomas Leeper to emulate the behavior of the <code>margins</code> command from <code>Stata</code>. These packages are trailblazers and strongly influenced the development of <code>marginaleffects</code>. The main benefits of <code>marginaleffects</code> over these packages are:</p>
<ul>
<li>Support more model types</li>
<li>Faster</li>
<li>Memory efficient</li>
<li>Plots using <code>ggplot2</code> instead of Base R</li>
<li>More extensive test suite</li>
<li>Active development</li>
</ul>
<p>The syntax of the two packages is very similar.</p>
<div id="average-marginal-effects" class="section level2">
<h2>Average Marginal Effects</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">library</span>(margins)</a>
<a class="sourceLine" id="cb10-2" title="2"><span class="kw">library</span>(marginaleffects)</a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4">mod &lt;-<span class="st"> </span><span class="kw">lm</span>(mpg <span class="op">~</span><span class="st"> </span>cyl <span class="op">+</span><span class="st"> </span>hp <span class="op">+</span><span class="st"> </span>wt, <span class="dt">data =</span> mtcars)</a>
<a class="sourceLine" id="cb10-5" title="5"></a>
<a class="sourceLine" id="cb10-6" title="6">mar &lt;-<span class="st"> </span><span class="kw">margins</span>(mod)</a>
<a class="sourceLine" id="cb10-7" title="7"><span class="kw">summary</span>(mar)</a>
<a class="sourceLine" id="cb10-8" title="8"><span class="co">#&gt;  factor     AME     SE       z      p   lower   upper</span></a>
<a class="sourceLine" id="cb10-9" title="9"><span class="co">#&gt;     cyl -0.9416 0.5509 -1.7092 0.0874 -2.0214  0.1382</span></a>
<a class="sourceLine" id="cb10-10" title="10"><span class="co">#&gt;      hp -0.0180 0.0119 -1.5188 0.1288 -0.0413  0.0052</span></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co">#&gt;      wt -3.1670 0.7406 -4.2764 0.0000 -4.6185 -1.7155</span></a>
<a class="sourceLine" id="cb10-12" title="12"></a>
<a class="sourceLine" id="cb10-13" title="13">mfx &lt;-<span class="st"> </span><span class="kw">marginaleffects</span>(mod)</a>
<a class="sourceLine" id="cb10-14" title="14"><span class="kw">summary</span>(mfx)</a>
<a class="sourceLine" id="cb10-15" title="15"><span class="co">#&gt; Average marginal effects </span></a>
<a class="sourceLine" id="cb10-16" title="16"><span class="co">#&gt;   Term   Effect Std. Error z value   Pr(&gt;|z|)    2.5 %    97.5 %</span></a>
<a class="sourceLine" id="cb10-17" title="17"><span class="co">#&gt; 1  cyl -0.94162    0.55092  -1.709   0.087417 -2.02139  0.138159</span></a>
<a class="sourceLine" id="cb10-18" title="18"><span class="co">#&gt; 2   hp -0.01804    0.01188  -1.519   0.128803 -0.04132  0.005239</span></a>
<a class="sourceLine" id="cb10-19" title="19"><span class="co">#&gt; 3   wt -3.16697    0.74058  -4.276 1.8997e-05 -4.61848 -1.715471</span></a>
<a class="sourceLine" id="cb10-20" title="20"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-21" title="21"><span class="co">#&gt; Model type:  lm </span></a>
<a class="sourceLine" id="cb10-22" title="22"><span class="co">#&gt; Prediction type:  response</span></a></code></pre></div>
</div>
<div id="individual-level-marginal-effects" class="section level2">
<h2>Individual-Level Marginal Effects</h2>
<p>Marginal effects in a user-specified data frame:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">head</span>(<span class="kw">data.frame</span>(mar))</a>
<a class="sourceLine" id="cb11-2" title="2"><span class="co">#&gt;    mpg cyl disp  hp drat    wt  qsec vs am gear carb   fitted se.fitted   dydx_cyl    dydx_hp</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="co">#&gt; 1 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4 22.82043 0.6876212 -0.9416168 -0.0180381</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="co">#&gt; 2 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4 22.01285 0.6056817 -0.9416168 -0.0180381</span></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="co">#&gt; 3 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1 25.96040 0.7349593 -0.9416168 -0.0180381</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="co">#&gt; 4 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1 20.93608 0.5800910 -0.9416168 -0.0180381</span></a>
<a class="sourceLine" id="cb11-7" title="7"><span class="co">#&gt; 5 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2 17.16780 0.8322986 -0.9416168 -0.0180381</span></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="co">#&gt; 6 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1 20.25036 0.6638322 -0.9416168 -0.0180381</span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="co">#&gt;     dydx_wt Var_dydx_cyl  Var_dydx_hp Var_dydx_wt X_weights X_at_number</span></a>
<a class="sourceLine" id="cb11-10" title="10"><span class="co">#&gt; 1 -3.166973    0.3035093 0.0001410454   0.5484543        NA           1</span></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="co">#&gt; 2 -3.166973    0.3035093 0.0001410454   0.5484543        NA           1</span></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="co">#&gt; 3 -3.166973    0.3035093 0.0001410454   0.5484543        NA           1</span></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co">#&gt; 4 -3.166973    0.3035093 0.0001410454   0.5484543        NA           1</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="co">#&gt; 5 -3.166973    0.3035093 0.0001410454   0.5484543        NA           1</span></a>
<a class="sourceLine" id="cb11-15" title="15"><span class="co">#&gt; 6 -3.166973    0.3035093 0.0001410454   0.5484543        NA           1</span></a>
<a class="sourceLine" id="cb11-16" title="16"></a>
<a class="sourceLine" id="cb11-17" title="17"><span class="kw">head</span>(mfx)</a>
<a class="sourceLine" id="cb11-18" title="18"><span class="co">#&gt;   rowid     type term       dydx std.error statistic    p.value  conf.low conf.high  mpg cyl  hp</span></a>
<a class="sourceLine" id="cb11-19" title="19"><span class="co">#&gt; 1     1 response  cyl -0.9416168 0.5509164 -1.709183 0.08741712 -2.021393 0.1381595 21.0   6 110</span></a>
<a class="sourceLine" id="cb11-20" title="20"><span class="co">#&gt; 2     2 response  cyl -0.9416168 0.5509164 -1.709183 0.08741712 -2.021393 0.1381595 21.0   6 110</span></a>
<a class="sourceLine" id="cb11-21" title="21"><span class="co">#&gt; 3     3 response  cyl -0.9416168 0.5509160 -1.709184 0.08741689 -2.021392 0.1381588 22.8   4  93</span></a>
<a class="sourceLine" id="cb11-22" title="22"><span class="co">#&gt; 4     4 response  cyl -0.9416168 0.5509164 -1.709183 0.08741712 -2.021393 0.1381595 21.4   6 110</span></a>
<a class="sourceLine" id="cb11-23" title="23"><span class="co">#&gt; 5     5 response  cyl -0.9416168 0.5509167 -1.709182 0.08741729 -2.021394 0.1381601 18.7   8 175</span></a>
<a class="sourceLine" id="cb11-24" title="24"><span class="co">#&gt; 6     6 response  cyl -0.9416168 0.5509164 -1.709183 0.08741712 -2.021393 0.1381595 18.1   6 105</span></a>
<a class="sourceLine" id="cb11-25" title="25"><span class="co">#&gt;      wt</span></a>
<a class="sourceLine" id="cb11-26" title="26"><span class="co">#&gt; 1 2.620</span></a>
<a class="sourceLine" id="cb11-27" title="27"><span class="co">#&gt; 2 2.875</span></a>
<a class="sourceLine" id="cb11-28" title="28"><span class="co">#&gt; 3 2.320</span></a>
<a class="sourceLine" id="cb11-29" title="29"><span class="co">#&gt; 4 3.215</span></a>
<a class="sourceLine" id="cb11-30" title="30"><span class="co">#&gt; 5 3.440</span></a>
<a class="sourceLine" id="cb11-31" title="31"><span class="co">#&gt; 6 3.460</span></a>
<a class="sourceLine" id="cb11-32" title="32">nd &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">cyl =</span> <span class="dv">4</span>, <span class="dt">hp =</span> <span class="dv">110</span>, <span class="dt">wt =</span> <span class="dv">3</span>)</a></code></pre></div>
</div>
<div id="marginal-effects-at-the-mean" class="section level2">
<h2>Marginal Effects at the Mean</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">mar &lt;-<span class="st"> </span><span class="kw">margins</span>(mod, <span class="dt">data =</span> <span class="kw">data.frame</span>(<span class="kw">mean_or_mode</span>(mtcars)), <span class="dt">unit_ses =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-2" title="2"><span class="kw">data.frame</span>(mar)</a>
<a class="sourceLine" id="cb12-3" title="3"><span class="co">#&gt;        mpg    cyl     disp       hp     drat      wt     qsec     vs      am   gear   carb</span></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="co">#&gt; 1 20.09062 6.1875 230.7219 146.6875 3.596563 3.21725 17.84875 0.4375 0.40625 3.6875 2.8125</span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="co">#&gt;     fitted se.fitted   dydx_cyl    dydx_hp   dydx_wt Var_dydx_cyl  Var_dydx_hp Var_dydx_wt</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="co">#&gt; 1 20.09062 0.4439832 -0.9416168 -0.0180381 -3.166973    0.3034971 0.0001410454     0.54846</span></a>
<a class="sourceLine" id="cb12-7" title="7"><span class="co">#&gt;   SE_dydx_cyl SE_dydx_hp SE_dydx_wt X_weights X_at_number</span></a>
<a class="sourceLine" id="cb12-8" title="8"><span class="co">#&gt; 1   0.5509057 0.01187626  0.7405808        NA           1</span></a>
<a class="sourceLine" id="cb12-9" title="9"></a>
<a class="sourceLine" id="cb12-10" title="10"><span class="kw">marginaleffects</span>(mod, <span class="dt">newdata =</span> <span class="kw">datagrid</span>())</a>
<a class="sourceLine" id="cb12-11" title="11"><span class="co">#&gt;   rowid     type term       dydx  std.error statistic      p.value    conf.low    conf.high</span></a>
<a class="sourceLine" id="cb12-12" title="12"><span class="co">#&gt; 1     1 response  cyl -0.9416168 0.55091643 -1.709183 8.741712e-02 -2.02139317  0.138159543</span></a>
<a class="sourceLine" id="cb12-13" title="13"><span class="co">#&gt; 2     1 response   hp -0.0180381 0.01187625 -1.518838 1.288033e-01 -0.04131513  0.005238922</span></a>
<a class="sourceLine" id="cb12-14" title="14"><span class="co">#&gt; 3     1 response   wt -3.1669731 0.74057568 -4.276367 1.899683e-05 -4.61847477 -1.715471455</span></a>
<a class="sourceLine" id="cb12-15" title="15"><span class="co">#&gt;      cyl       hp      wt</span></a>
<a class="sourceLine" id="cb12-16" title="16"><span class="co">#&gt; 1 6.1875 146.6875 3.21725</span></a>
<a class="sourceLine" id="cb12-17" title="17"><span class="co">#&gt; 2 6.1875 146.6875 3.21725</span></a>
<a class="sourceLine" id="cb12-18" title="18"><span class="co">#&gt; 3 6.1875 146.6875 3.21725</span></a></code></pre></div>
</div>
<div id="counterfactual-average-marginal-effects" class="section level2">
<h2>Counterfactual Average Marginal Effects</h2>
<p>The <code>at</code> argument of the <code>margins</code> package emulates <code>Stata</code> by fixing the values of some variables at user-specified values, and by replicating the full dataset several times for each combination of the supplied values (see the <code>Stata</code> section below). For example, if the dataset includes 32 rows and the user calls <code>at=list(cyl=c(4, 6))</code>, <code>margins</code> will compute 64 unit-level marginal effects estimates:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">dat &lt;-<span class="st"> </span>mtcars</a>
<a class="sourceLine" id="cb13-2" title="2">dat<span class="op">$</span>cyl &lt;-<span class="st"> </span><span class="kw">factor</span>(dat<span class="op">$</span>cyl)</a>
<a class="sourceLine" id="cb13-3" title="3">mod &lt;-<span class="st"> </span><span class="kw">lm</span>(mpg <span class="op">~</span><span class="st"> </span>cyl <span class="op">*</span><span class="st"> </span>hp <span class="op">+</span><span class="st"> </span>wt, <span class="dt">data =</span> mtcars)</a>
<a class="sourceLine" id="cb13-4" title="4"></a>
<a class="sourceLine" id="cb13-5" title="5">mar &lt;-<span class="st"> </span><span class="kw">margins</span>(mod, <span class="dt">at =</span> <span class="kw">list</span>(<span class="dt">cyl =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>)))</a>
<a class="sourceLine" id="cb13-6" title="6"><span class="kw">summary</span>(mar)</a>
<a class="sourceLine" id="cb13-7" title="7"><span class="co">#&gt;  factor    cyl     AME     SE       z      p   lower   upper</span></a>
<a class="sourceLine" id="cb13-8" title="8"><span class="co">#&gt;     cyl 4.0000  0.0381 0.5999  0.0636 0.9493 -1.1376  1.2139</span></a>
<a class="sourceLine" id="cb13-9" title="9"><span class="co">#&gt;     cyl 6.0000  0.0381 0.5999  0.0636 0.9493 -1.1376  1.2138</span></a>
<a class="sourceLine" id="cb13-10" title="10"><span class="co">#&gt;     cyl 8.0000  0.0381 0.5999  0.0636 0.9493 -1.1376  1.2139</span></a>
<a class="sourceLine" id="cb13-11" title="11"><span class="co">#&gt;      hp 4.0000 -0.0878 0.0267 -3.2937 0.0010 -0.1400 -0.0355</span></a>
<a class="sourceLine" id="cb13-12" title="12"><span class="co">#&gt;      hp 6.0000 -0.0499 0.0154 -3.2397 0.0012 -0.0800 -0.0197</span></a>
<a class="sourceLine" id="cb13-13" title="13"><span class="co">#&gt;      hp 8.0000 -0.0120 0.0108 -1.1065 0.2685 -0.0332  0.0092</span></a>
<a class="sourceLine" id="cb13-14" title="14"><span class="co">#&gt;      wt 4.0000 -3.1198 0.6613 -4.7175 0.0000 -4.4160 -1.8236</span></a>
<a class="sourceLine" id="cb13-15" title="15"><span class="co">#&gt;      wt 6.0000 -3.1198 0.6613 -4.7175 0.0000 -4.4160 -1.8236</span></a>
<a class="sourceLine" id="cb13-16" title="16"><span class="co">#&gt;      wt 8.0000 -3.1198 0.6613 -4.7176 0.0000 -4.4160 -1.8237</span></a>
<a class="sourceLine" id="cb13-17" title="17"></a>
<a class="sourceLine" id="cb13-18" title="18">mfx &lt;-<span class="st"> </span><span class="kw">marginaleffects</span>(mod, <span class="dt">newdata =</span> <span class="kw">datagrid</span>(<span class="dt">cyl =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>), <span class="dt">grid.type =</span> <span class="st">&quot;counterfactual&quot;</span>))</a>
<a class="sourceLine" id="cb13-19" title="19"><span class="kw">summary</span>(mfx, <span class="dt">by =</span> <span class="st">&quot;cyl&quot;</span>)</a>
<a class="sourceLine" id="cb13-20" title="20"><span class="co">#&gt; Average marginal effects </span></a>
<a class="sourceLine" id="cb13-21" title="21"><span class="co">#&gt;   Term cyl   Effect Std. Error  z value   Pr(&gt;|z|)    2.5 %    97.5 %</span></a>
<a class="sourceLine" id="cb13-22" title="22"><span class="co">#&gt; 1  cyl   4  0.03814    0.59989  0.06357 0.94930949 -1.13762  1.213899</span></a>
<a class="sourceLine" id="cb13-23" title="23"><span class="co">#&gt; 2  cyl   6  0.03814    0.59989  0.06357 0.94930949 -1.13762  1.213899</span></a>
<a class="sourceLine" id="cb13-24" title="24"><span class="co">#&gt; 3  cyl   8  0.03814    0.59989  0.06357 0.94930949 -1.13762  1.213899</span></a>
<a class="sourceLine" id="cb13-25" title="25"><span class="co">#&gt; 4   hp   4 -0.08778    0.02665 -3.29366 0.00098891 -0.14001 -0.035545</span></a>
<a class="sourceLine" id="cb13-26" title="26"><span class="co">#&gt; 5   hp   6 -0.04987    0.01539 -3.23974 0.00119638 -0.08004 -0.019701</span></a>
<a class="sourceLine" id="cb13-27" title="27"><span class="co">#&gt; 6   hp   8 -0.01197    0.01081 -1.10649 0.26851651 -0.03316  0.009229</span></a>
<a class="sourceLine" id="cb13-28" title="28"><span class="co">#&gt; 7   wt   4 -3.11981    0.66132 -4.71754 2.3871e-06 -4.41598 -1.823648</span></a>
<a class="sourceLine" id="cb13-29" title="29"><span class="co">#&gt; 8   wt   6 -3.11981    0.66132 -4.71754 2.3871e-06 -4.41598 -1.823648</span></a>
<a class="sourceLine" id="cb13-30" title="30"><span class="co">#&gt; 9   wt   8 -3.11981    0.66132 -4.71754 2.3871e-06 -4.41598 -1.823648</span></a>
<a class="sourceLine" id="cb13-31" title="31"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb13-32" title="32"><span class="co">#&gt; Model type:  lm </span></a>
<a class="sourceLine" id="cb13-33" title="33"><span class="co">#&gt; Prediction type:  response</span></a></code></pre></div>
</div>
<div id="adjusted-presdictions" class="section level2">
<h2>Adjusted Presdictions</h2>
<p>The syntax to compute adjusted predictions using the <code>predictions</code> package or <code>marginaleffects</code> is very similar:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">prediction<span class="op">::</span><span class="kw">prediction</span>(mod) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb14-2" title="2"><span class="co">#&gt;    mpg cyl disp  hp drat    wt  qsec vs am gear carb   fitted se.fitted</span></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="co">#&gt; 1 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4 21.90488 0.6927034</span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="co">#&gt; 2 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4 21.10933 0.6266557</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="co">#&gt; 3 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1 25.64753 0.6652076</span></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="co">#&gt; 4 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1 20.04859 0.6041400</span></a>
<a class="sourceLine" id="cb14-7" title="7"><span class="co">#&gt; 5 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2 17.25445 0.7436172</span></a>
<a class="sourceLine" id="cb14-8" title="8"><span class="co">#&gt; 6 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1 19.53360 0.6436862</span></a>
<a class="sourceLine" id="cb14-9" title="9"></a>
<a class="sourceLine" id="cb14-10" title="10">marginaleffects<span class="op">::</span><span class="kw">predictions</span>(mod) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb14-11" title="11"><span class="co">#&gt;   rowid     type predicted std.error conf.low conf.high  mpg cyl  hp    wt</span></a>
<a class="sourceLine" id="cb14-12" title="12"><span class="co">#&gt; 1     1 response  21.90488 0.6927034 20.48357  23.32619 21.0   6 110 2.620</span></a>
<a class="sourceLine" id="cb14-13" title="13"><span class="co">#&gt; 2     2 response  21.10933 0.6266557 19.82354  22.39512 21.0   6 110 2.875</span></a>
<a class="sourceLine" id="cb14-14" title="14"><span class="co">#&gt; 3     3 response  25.64753 0.6652076 24.28264  27.01242 22.8   4  93 2.320</span></a>
<a class="sourceLine" id="cb14-15" title="15"><span class="co">#&gt; 4     4 response  20.04859 0.6041400 18.80900  21.28819 21.4   6 110 3.215</span></a>
<a class="sourceLine" id="cb14-16" title="16"><span class="co">#&gt; 5     5 response  17.25445 0.7436172 15.72867  18.78022 18.7   8 175 3.440</span></a>
<a class="sourceLine" id="cb14-17" title="17"><span class="co">#&gt; 6     6 response  19.53360 0.6436862 18.21286  20.85434 18.1   6 105 3.460</span></a></code></pre></div>
</div>
</div>
<div id="stata" class="section level1">
<h1><code>Stata</code></h1>
<p><code>Stata</code> is a good but expensive software package for statistical analysis. It is published by StataCorp LLC. This section compares <code>Stata</code>’s <code>margins</code> command to <code>marginaleffects</code>.</p>
<p>The results produced by <code>marginaleffects</code> are extensively tested against <code>Stata</code>. See the <a href="https://github.com/vincentarelbundock/marginaleffects/tree/main/tests/testthat/stata">test suite</a> for a list of the dozens of models where we compared estimates and standard errors.</p>
<div id="average-marginal-effect-ames" class="section level2">
<h2>Average Marginal Effect (AMEs)</h2>
<p>Marginal effects are unit-level quantities. To compute “average marginal effects”, we first calculate marginal effects for each observation in a dataset. Then, we take the mean of those unit-level marginal effects.</p>
<div id="stata-1" class="section level3">
<h3>Stata</h3>
<p>Both Stata’s <code>margins</code> command and the <code>marginaleffects</code> function can calculate average marginal effects (AMEs). Here is an example showing how to estimate AMEs in Stata:</p>
<pre><code>quietly reg mpg cyl hp wt
margins, dydx(*)

Average marginal effects                        Number of obs     =         32
Model VCE    : OLS
 
Expression   : Linear prediction, predict()
dy/dx w.r.t. : cyl hp wt
 
------------------------------------------------------------------------------
    |            Delta-method
    |      dy/dx   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
------------------------------------------------------------------------------
cyl |  -.9416168   .5509164    -1.71   0.098    -2.070118    .1868842
 hp |  -.0180381   .0118762    -1.52   0.140    -.0423655    .0062893
 wt |  -3.166973   .7405759    -4.28   0.000    -4.683974   -1.649972
------------------------------------------------------------------------------</code></pre>
</div>
<div id="marginaleffects" class="section level3">
<h3>marginaleffects</h3>
<p>The same results can be obtained with <code>marginaleffects()</code> and <code>summary()</code> like this:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">library</span>(<span class="st">&quot;marginaleffects&quot;</span>)</a>
<a class="sourceLine" id="cb16-2" title="2">mod &lt;-<span class="st"> </span><span class="kw">lm</span>(mpg <span class="op">~</span><span class="st"> </span>cyl <span class="op">+</span><span class="st"> </span>hp <span class="op">+</span><span class="st"> </span>wt, <span class="dt">data =</span> mtcars)</a>
<a class="sourceLine" id="cb16-3" title="3">mfx &lt;-<span class="st"> </span><span class="kw">marginaleffects</span>(mod)</a>
<a class="sourceLine" id="cb16-4" title="4"><span class="kw">summary</span>(mfx)</a>
<a class="sourceLine" id="cb16-5" title="5"><span class="co">#&gt; Average marginal effects </span></a>
<a class="sourceLine" id="cb16-6" title="6"><span class="co">#&gt;   Term   Effect Std. Error z value   Pr(&gt;|z|)    2.5 %    97.5 %</span></a>
<a class="sourceLine" id="cb16-7" title="7"><span class="co">#&gt; 1  cyl -0.94162    0.55092  -1.709   0.087417 -2.02139  0.138159</span></a>
<a class="sourceLine" id="cb16-8" title="8"><span class="co">#&gt; 2   hp -0.01804    0.01188  -1.519   0.128803 -0.04132  0.005239</span></a>
<a class="sourceLine" id="cb16-9" title="9"><span class="co">#&gt; 3   wt -3.16697    0.74058  -4.276 1.8997e-05 -4.61848 -1.715471</span></a>
<a class="sourceLine" id="cb16-10" title="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-11" title="11"><span class="co">#&gt; Model type:  lm </span></a>
<a class="sourceLine" id="cb16-12" title="12"><span class="co">#&gt; Prediction type:  response</span></a></code></pre></div>
<p>Note that <code>Stata</code> reports t statistics while <code>marginaleffects</code> reports Z. This produces slightly different p-values because this model has low degrees of freedom: <code>mtcars</code> only has 32 rows</p>
</div>
</div>
<div id="counterfactual-marginal-effects" class="section level2">
<h2>Counterfactual Marginal Effects</h2>
<p>A “counterfactual marginal effect” is a special quantity obtained by replicating a dataset while fixing some regressor to user-defined values.</p>
<p>Concretely, Stata computes counterfactual marginal effects in 3 steps:</p>
<ol style="list-style-type: decimal">
<li>Duplicate the whole dataset 3 times and sets the values of <code>cyl</code> to the three specified values in each of those subsets.</li>
<li>Calculate marginal effects for each observation in that large grid.</li>
<li>Take the average of marginal effects for each value of the variable of interest.</li>
</ol>
<div id="stata-2" class="section level3">
<h3>Stata</h3>
<p>With the <code>at</code> argument, Stata’s <code>margins</code> command estimates average <em>counterfactual</em> marginal effects. Here is an example:</p>
<pre><code>quietly reg mpg i.cyl##c.hp wt
margins, dydx(hp) at(cyl = (4 6 8))

Average marginal effects                        Number of obs     =         32
Model VCE    : OLS

Expression   : Linear prediction, predict()
dy/dx w.r.t. : hp

1._at        : cyl             =           4

2._at        : cyl             =           6

3._at        : cyl             =           8

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
hp           |
         _at |
          1  |   -.099466   .0348665    -2.85   0.009    -.1712749   -.0276571
          2  |  -.0213768    .038822    -0.55   0.587    -.1013323    .0585787
          3  |   -.013441   .0125138    -1.07   0.293    -.0392137    .0123317
------------------------------------------------------------------------------</code></pre>
<!-- Adapted from this GitHub issue: https://github.com/strengejacke/ggeffects/issues/249 -->
</div>
<div id="marginaleffects-1" class="section level3">
<h3>marginaleffects</h3>
<p>You can estimate average counterfactual marginal effects with <code>marginaleffects()</code> by, first, setting the <code>grid.type</code> argument of <code>data.grid()</code> to <code>&quot;counterfactual&quot;</code> and, second, by telling the <code>summary</code> function that you want to average within groups:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">mod &lt;-<span class="st"> </span><span class="kw">lm</span>(mpg <span class="op">~</span><span class="st"> </span><span class="kw">as.factor</span>(cyl) <span class="op">*</span><span class="st"> </span>hp <span class="op">+</span><span class="st"> </span>wt, <span class="dt">data =</span> mtcars)</a>
<a class="sourceLine" id="cb18-2" title="2"></a>
<a class="sourceLine" id="cb18-3" title="3">mfx &lt;-<span class="st"> </span><span class="kw">marginaleffects</span>(</a>
<a class="sourceLine" id="cb18-4" title="4">    mod,</a>
<a class="sourceLine" id="cb18-5" title="5">    <span class="dt">variables =</span> <span class="st">&quot;hp&quot;</span>,</a>
<a class="sourceLine" id="cb18-6" title="6">    <span class="dt">newdata =</span> <span class="kw">datagrid</span>(<span class="dt">cyl =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>),</a>
<a class="sourceLine" id="cb18-7" title="7">                       <span class="dt">grid.type =</span> <span class="st">&quot;counterfactual&quot;</span>))</a>
<a class="sourceLine" id="cb18-8" title="8"></a>
<a class="sourceLine" id="cb18-9" title="9"><span class="kw">summary</span>(mfx, <span class="dt">by =</span> <span class="st">&quot;cyl&quot;</span>)</a>
<a class="sourceLine" id="cb18-10" title="10"><span class="co">#&gt; Average marginal effects </span></a>
<a class="sourceLine" id="cb18-11" title="11"><span class="co">#&gt;   Term cyl   Effect Std. Error z value Pr(&gt;|z|)    2.5 %   97.5 %</span></a>
<a class="sourceLine" id="cb18-12" title="12"><span class="co">#&gt; 1   hp   4 -0.09947    0.03487 -2.8528 0.004334 -0.16780 -0.03113</span></a>
<a class="sourceLine" id="cb18-13" title="13"><span class="co">#&gt; 2   hp   6 -0.02138    0.03882 -0.5506 0.581884 -0.09747  0.05471</span></a>
<a class="sourceLine" id="cb18-14" title="14"><span class="co">#&gt; 3   hp   8 -0.01344    0.01251 -1.0741 0.282780 -0.03797  0.01109</span></a>
<a class="sourceLine" id="cb18-15" title="15"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-16" title="16"><span class="co">#&gt; Model type:  lm </span></a>
<a class="sourceLine" id="cb18-17" title="17"><span class="co">#&gt; Prediction type:  response</span></a></code></pre></div>
<p>This is equivalent to taking the group-wise mean of observation-level marginal effects:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">aggregate</span>(dydx <span class="op">~</span><span class="st"> </span>term <span class="op">+</span><span class="st"> </span>cyl, <span class="dt">data =</span> mfx, <span class="dt">FUN =</span> mean)</a>
<a class="sourceLine" id="cb19-2" title="2"><span class="co">#&gt;   term cyl        dydx</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="co">#&gt; 1   hp   4 -0.09946598</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="co">#&gt; 2   hp   6 -0.02137679</span></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="co">#&gt; 3   hp   8 -0.01344103</span></a></code></pre></div>
<!-- Taken from https://github.com/vincentarelbundock/marginaleffects/issues/226 -->
<p>Note that following <code>Stata</code>, the standard errors for group-averaged marginal effects are computed by taking the “Jacobian at the mean:”</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">J &lt;-<span class="st"> </span><span class="kw">attr</span>(mfx, <span class="st">&quot;J&quot;</span>)</a>
<a class="sourceLine" id="cb20-2" title="2">J_mean &lt;-<span class="st"> </span><span class="kw">aggregate</span>(J, <span class="dt">by =</span> <span class="kw">list</span>(mfx<span class="op">$</span>cyl), <span class="dt">FUN =</span> mean)</a>
<a class="sourceLine" id="cb20-3" title="3">J_mean &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(J_mean[, <span class="dv">2</span><span class="op">:</span><span class="kw">ncol</span>(J_mean)])</a>
<a class="sourceLine" id="cb20-4" title="4"><span class="kw">sqrt</span>(<span class="kw">diag</span>(J_mean <span class="op">%*%</span><span class="st"> </span><span class="kw">vcov</span>(mod) <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(J_mean)))</a>
<a class="sourceLine" id="cb20-5" title="5"><span class="co">#&gt; [1] 0.03486650 0.03882204 0.01251382</span></a></code></pre></div>
</div>
</div>
<div id="average-counterfactual-adjusted-predictions" class="section level2">
<h2>Average Counterfactual Adjusted Predictions</h2>
<div id="stata-3" class="section level3">
<h3>Stata</h3>
<p>Just like Stata’s <code>margins</code> command computes average counterfactual marginal effects, it can also estimate <em>average counterfactual adjusted predictions</em>.</p>
<p>Here is an example:</p>
<pre><code>quietly reg mpg i.cyl##c.hp wt
margins, at(cyl = (4 6 8))

Predictive margins                              Number of obs     =         32
Model VCE    : OLS

Expression   : Linear prediction, predict()

1._at        : cyl             =           4

2._at        : cyl             =           6

3._at        : cyl             =           8

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         _at |
          1  |   17.44233   2.372914     7.35   0.000     12.55522    22.32944
          2  |    18.9149   1.291483    14.65   0.000     16.25505    21.57476
          3  |   18.33318   1.123874    16.31   0.000     16.01852    20.64785
------------------------------------------------------------------------------</code></pre>
<p>Again, this is what Stata does in the background:</p>
<ol style="list-style-type: decimal">
<li>It duplicates the whole dataset 3 times and sets the values of <code>cyl</code> to the three specified values in each of those subsets.</li>
<li>It calculates predictions for that large grid.</li>
<li>It takes the average prediction for each value of <code>cyl</code>.</li>
</ol>
<p>In other words, average counterfactual adjusted predictions as implemented by Stata are a hybrid between predictions at the observed values (the default in <code>marginaleffects::predictions</code>) and predictions at representative values.</p>
</div>
<div id="marginaleffects-2" class="section level3">
<h3>marginaleffects</h3>
<p>You can estimate average counterfactual adjusted predictions with <code>predictions()</code> by, first, setting the <code>grid.type</code> argument of <code>data.grid()</code> to <code>&quot;counterfactual&quot;</code> and, second, by averaging the predictions, for example using <code>aggregate()</code> or <code>dplyr::summarise()</code>.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">mod &lt;-<span class="st"> </span><span class="kw">lm</span>(mpg <span class="op">~</span><span class="st"> </span><span class="kw">as.factor</span>(cyl) <span class="op">*</span><span class="st"> </span>hp <span class="op">+</span><span class="st"> </span>wt, <span class="dt">data =</span> mtcars)</a>
<a class="sourceLine" id="cb22-2" title="2"></a>
<a class="sourceLine" id="cb22-3" title="3"></a>
<a class="sourceLine" id="cb22-4" title="4">pred &lt;-<span class="st"> </span><span class="kw">predictions</span>(mod,</a>
<a class="sourceLine" id="cb22-5" title="5">                    <span class="dt">newdata =</span> <span class="kw">datagrid</span>(<span class="dt">cyl =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>),</a>
<a class="sourceLine" id="cb22-6" title="6">                                       <span class="dt">grid.type =</span> <span class="st">&quot;counterfactual&quot;</span>))</a>
<a class="sourceLine" id="cb22-7" title="7"></a>
<a class="sourceLine" id="cb22-8" title="8"><span class="kw">aggregate</span>(pred<span class="op">$</span>predicted, <span class="dt">by =</span> <span class="kw">list</span>(pred<span class="op">$</span>cyl), <span class="dt">FUN =</span> mean)</a>
<a class="sourceLine" id="cb22-9" title="9"><span class="co">#&gt;   Group.1        x</span></a>
<a class="sourceLine" id="cb22-10" title="10"><span class="co">#&gt; 1       4 17.44233</span></a>
<a class="sourceLine" id="cb22-11" title="11"><span class="co">#&gt; 2       6 18.91490</span></a>
<a class="sourceLine" id="cb22-12" title="12"><span class="co">#&gt; 3       8 18.33318</span></a></code></pre></div>
<p>Note that standard errors are not yet available for average adjusted predictions.</p>
</div>
</div>
</div>
<div id="brmsmargins" class="section level1">
<h1><code>brmsmargins</code></h1>
<p><a href="https://joshuawiley.com/brmsmargins/">The <code>brmsmargins</code> package</a> is developed by Joshua Wiley:</p>
<blockquote>
<p>This package has functions to calculate marginal effects from brms models ( <a href="http://paul-buerkner.github.io/brms/" class="uri">http://paul-buerkner.github.io/brms/</a> ). A central motivator is to calculate average marginal effects (AMEs) for continuous and discrete predictors in fixed effects only and mixed effects regression models including location scale models.</p>
</blockquote>
<p>The two main advantages of <code>brmsmargins</code> over <code>marginaleffects</code> are:</p>
<ol style="list-style-type: decimal">
<li>Ability to compute “Marginal Coefficients” following the method described in <a href="https://doi.org/10.1111/biom.12707">Hedeker et al (2012).</a></li>
<li>Ability to <a href="https://joshuawiley.com/brmsmargins/articles/mixed-effects-marginaleffects.html">“integrate out random effects.”</a></li>
</ol>
<p>The main advantages of <code>marginaleffects</code> over <code>brmsmargins</code> are:</p>
<ol style="list-style-type: decimal">
<li>Support for 60+ model types, rather than just the <code>brms</code> package.</li>
<li>Simpler user interface (subjective).</li>
</ol>
<p>The rest of this section presents side-by-side replications of some of the analyses from the <code>brmsmargins</code> vignettes in order to show highlight parallels and differences in syntax.</p>
<div id="marginal-effects-for-fixed-effects-models" class="section level2">
<h2>Marginal Effects for Fixed Effects Models</h2>
<div id="ames-for-logistic-regression" class="section level3">
<h3>AMEs for Logistic Regression</h3>
<p>Estimate a logistic regression model with <code>brms</code>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="kw">library</span>(brms)</a>
<a class="sourceLine" id="cb23-2" title="2"><span class="kw">library</span>(brmsmargins)</a>
<a class="sourceLine" id="cb23-3" title="3"><span class="kw">library</span>(marginaleffects)</a>
<a class="sourceLine" id="cb23-4" title="4"><span class="kw">library</span>(data.table)</a>
<a class="sourceLine" id="cb23-5" title="5"><span class="kw">library</span>(withr)</a>
<a class="sourceLine" id="cb23-6" title="6">h &lt;-<span class="st"> </span><span class="fl">1e-4</span></a>
<a class="sourceLine" id="cb23-7" title="7"></a>
<a class="sourceLine" id="cb23-8" title="8">void &lt;-<span class="st"> </span><span class="kw">capture.output</span>(</a>
<a class="sourceLine" id="cb23-9" title="9">    bayes.logistic &lt;-<span class="st"> </span><span class="kw">brm</span>(</a>
<a class="sourceLine" id="cb23-10" title="10">      vs <span class="op">~</span><span class="st"> </span>am <span class="op">+</span><span class="st"> </span>mpg, <span class="dt">data =</span> mtcars,</a>
<a class="sourceLine" id="cb23-11" title="11">      <span class="dt">family =</span> <span class="st">&quot;bernoulli&quot;</span>, <span class="dt">seed =</span> <span class="dv">1234</span>,</a>
<a class="sourceLine" id="cb23-12" title="12">      <span class="dt">silent =</span> <span class="dv">2</span>, <span class="dt">refresh =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb23-13" title="13">      <span class="dt">chains =</span> 4L, <span class="dt">cores =</span> 4L)</a>
<a class="sourceLine" id="cb23-14" title="14">)</a></code></pre></div>
<p>Compute AMEs manually:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">d1 &lt;-<span class="st"> </span>d2 &lt;-<span class="st"> </span>mtcars</a>
<a class="sourceLine" id="cb24-2" title="2">d2<span class="op">$</span>mpg &lt;-<span class="st"> </span>d2<span class="op">$</span>mpg <span class="op">+</span><span class="st"> </span>h</a>
<a class="sourceLine" id="cb24-3" title="3">p1 &lt;-<span class="st"> </span><span class="kw">posterior_epred</span>(bayes.logistic, <span class="dt">newdata =</span> d1)</a>
<a class="sourceLine" id="cb24-4" title="4">p2 &lt;-<span class="st"> </span><span class="kw">posterior_epred</span>(bayes.logistic, <span class="dt">newdata =</span> d2)</a>
<a class="sourceLine" id="cb24-5" title="5">m &lt;-<span class="st"> </span>(p2 <span class="op">-</span><span class="st"> </span>p1) <span class="op">/</span><span class="st"> </span>h</a>
<a class="sourceLine" id="cb24-6" title="6"><span class="kw">quantile</span>(<span class="kw">rowMeans</span>(m), <span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">.025</span>, <span class="fl">.975</span>))</a>
<a class="sourceLine" id="cb24-7" title="7"><span class="co">#&gt;        50%       2.5%      97.5% </span></a>
<a class="sourceLine" id="cb24-8" title="8"><span class="co">#&gt; 0.07014014 0.05437810 0.09159280</span></a></code></pre></div>
<p>Compute AMEs with <code>brmsmargins</code>:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1">bm &lt;-<span class="st"> </span><span class="kw">brmsmargins</span>(</a>
<a class="sourceLine" id="cb25-2" title="2">  bayes.logistic,</a>
<a class="sourceLine" id="cb25-3" title="3">  <span class="dt">add =</span> <span class="kw">data.frame</span>(<span class="dt">mpg =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>h)),</a>
<a class="sourceLine" id="cb25-4" title="4">  <span class="dt">contrasts =</span> <span class="kw">cbind</span>(<span class="st">&quot;AME MPG&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>h, <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>h)),</a>
<a class="sourceLine" id="cb25-5" title="5">  <span class="dt">CI =</span> <span class="fl">0.95</span>,</a>
<a class="sourceLine" id="cb25-6" title="6">  <span class="dt">CIType =</span> <span class="st">&quot;ETI&quot;</span>)</a>
<a class="sourceLine" id="cb25-7" title="7"><span class="kw">data.frame</span>(bm<span class="op">$</span>ContrastSummary)</a>
<a class="sourceLine" id="cb25-8" title="8"><span class="co">#&gt;            M        Mdn        LL        UL PercentROPE PercentMID   CI CIType ROPE  MID   Label</span></a>
<a class="sourceLine" id="cb25-9" title="9"><span class="co">#&gt; 1 0.07118446 0.07014014 0.0543781 0.0915928          NA         NA 0.95    ETI &lt;NA&gt; &lt;NA&gt; AME MPG</span></a></code></pre></div>
<p>Compute AMEs using <code>marginaleffects</code>:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1">mfx &lt;-<span class="st"> </span><span class="kw">marginaleffects</span>(bayes.logistic) </a>
<a class="sourceLine" id="cb26-2" title="2"><span class="kw">summary</span>(mfx)</a>
<a class="sourceLine" id="cb26-3" title="3"><span class="co">#&gt; Average marginal effects </span></a>
<a class="sourceLine" id="cb26-4" title="4"><span class="co">#&gt;   Term   Effect    2.5 %   97.5 %</span></a>
<a class="sourceLine" id="cb26-5" title="5"><span class="co">#&gt; 1   am -0.30976 -0.52182 -0.07808</span></a>
<a class="sourceLine" id="cb26-6" title="6"><span class="co">#&gt; 2  mpg  0.07118  0.05438  0.09159</span></a>
<a class="sourceLine" id="cb26-7" title="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb26-8" title="8"><span class="co">#&gt; Model type:  brmsfit </span></a>
<a class="sourceLine" id="cb26-9" title="9"><span class="co">#&gt; Prediction type:  response</span></a></code></pre></div>
<p>The <code>mpg</code> element of the <code>Effect</code> column from <code>marginaleffects</code> matches the the <code>M</code> column of the output from <code>brmsmargins</code>.</p>
</div>
</div>
<div id="marginal-effects-for-mixed-effects-models" class="section level2">
<h2>Marginal Effects for Mixed Effects Models</h2>
<p>Estimate a mixed effects logistic regression model with <code>brms</code>:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1">d &lt;-<span class="st"> </span>withr<span class="op">::</span><span class="kw">with_seed</span>(</a>
<a class="sourceLine" id="cb27-2" title="2">  <span class="dt">seed =</span> <span class="dv">12345</span>, <span class="dt">code =</span> {</a>
<a class="sourceLine" id="cb27-3" title="3">    nGroups &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb27-4" title="4">    nObs &lt;-<span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb27-5" title="5">    theta.location &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rnorm</span>(nGroups <span class="op">*</span><span class="st"> </span><span class="dv">2</span>), <span class="dt">nrow =</span> nGroups, <span class="dt">ncol =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb27-6" title="6">    theta.location[, <span class="dv">1</span>] &lt;-<span class="st"> </span>theta.location[, <span class="dv">1</span>] <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(theta.location[, <span class="dv">1</span>])</a>
<a class="sourceLine" id="cb27-7" title="7">    theta.location[, <span class="dv">2</span>] &lt;-<span class="st"> </span>theta.location[, <span class="dv">2</span>] <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(theta.location[, <span class="dv">2</span>])</a>
<a class="sourceLine" id="cb27-8" title="8">    theta.location[, <span class="dv">1</span>] &lt;-<span class="st"> </span>theta.location[, <span class="dv">1</span>] <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(theta.location[, <span class="dv">1</span>])</a>
<a class="sourceLine" id="cb27-9" title="9">    theta.location[, <span class="dv">2</span>] &lt;-<span class="st"> </span>theta.location[, <span class="dv">2</span>] <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(theta.location[, <span class="dv">2</span>])</a>
<a class="sourceLine" id="cb27-10" title="10">    theta.location &lt;-<span class="st"> </span>theta.location <span class="op">%*%</span><span class="st"> </span><span class="kw">chol</span>(<span class="kw">matrix</span>(<span class="kw">c</span>(<span class="fl">1.5</span>, <span class="fl">-.25</span>, <span class="fl">-.25</span>, <span class="fl">.5</span><span class="op">^</span><span class="dv">2</span>), <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb27-11" title="11">    theta.location[, <span class="dv">1</span>] &lt;-<span class="st"> </span>theta.location[, <span class="dv">1</span>] <span class="op">-</span><span class="st"> </span><span class="fl">2.5</span></a>
<a class="sourceLine" id="cb27-12" title="12">    theta.location[, <span class="dv">2</span>] &lt;-<span class="st"> </span>theta.location[, <span class="dv">2</span>] <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb27-13" title="13">    d &lt;-<span class="st"> </span><span class="kw">data.table</span>(</a>
<a class="sourceLine" id="cb27-14" title="14">      <span class="dt">x =</span> <span class="kw">rep</span>(<span class="kw">rep</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>, <span class="dt">each =</span> nObs <span class="op">/</span><span class="st"> </span><span class="dv">2</span>), <span class="dt">times =</span> nGroups))</a>
<a class="sourceLine" id="cb27-15" title="15">    d[, ID <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">rep</span>(<span class="kw">seq_len</span>(nGroups), <span class="dt">each =</span> nObs)]</a>
<a class="sourceLine" id="cb27-16" title="16"></a>
<a class="sourceLine" id="cb27-17" title="17">    <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_len</span>(nGroups)) {</a>
<a class="sourceLine" id="cb27-18" title="18">      d[ID <span class="op">==</span><span class="st"> </span>i, y <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">rbinom</span>(</a>
<a class="sourceLine" id="cb27-19" title="19">        <span class="dt">n =</span> nObs,</a>
<a class="sourceLine" id="cb27-20" title="20">        <span class="dt">size =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb27-21" title="21">        <span class="dt">prob =</span> <span class="kw">plogis</span>(theta.location[i, <span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>theta.location[i, <span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>x))</a>
<a class="sourceLine" id="cb27-22" title="22">        ]</a>
<a class="sourceLine" id="cb27-23" title="23">    }</a>
<a class="sourceLine" id="cb27-24" title="24">    <span class="kw">copy</span>(d)</a>
<a class="sourceLine" id="cb27-25" title="25">  })</a>
<a class="sourceLine" id="cb27-26" title="26"></a>
<a class="sourceLine" id="cb27-27" title="27">void &lt;-<span class="st"> </span><span class="kw">capture.output</span>(</a>
<a class="sourceLine" id="cb27-28" title="28">    mlogit &lt;-<span class="st"> </span>brms<span class="op">::</span><span class="kw">brm</span>(</a>
<a class="sourceLine" id="cb27-29" title="29">      y <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x <span class="op">|</span><span class="st"> </span>ID), <span class="dt">family =</span> <span class="st">&quot;bernoulli&quot;</span>,</a>
<a class="sourceLine" id="cb27-30" title="30">      <span class="dt">data =</span> d, <span class="dt">seed =</span> <span class="dv">1234</span>,</a>
<a class="sourceLine" id="cb27-31" title="31">      <span class="dt">silent =</span> <span class="dv">2</span>, <span class="dt">refresh =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb27-32" title="32">      <span class="dt">chains =</span> 4L, <span class="dt">cores =</span> 4L)</a>
<a class="sourceLine" id="cb27-33" title="33">)</a></code></pre></div>
<div id="ame-including-random-effects" class="section level3">
<h3>AME: Including Random Effects</h3>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1">bm &lt;-<span class="st"> </span><span class="kw">brmsmargins</span>(</a>
<a class="sourceLine" id="cb28-2" title="2">  mlogit,</a>
<a class="sourceLine" id="cb28-3" title="3">  <span class="dt">add =</span> <span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">0</span>, h)),</a>
<a class="sourceLine" id="cb28-4" title="4">  <span class="dt">contrasts =</span> <span class="kw">cbind</span>(<span class="st">&quot;AME x&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>h, <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>h)),</a>
<a class="sourceLine" id="cb28-5" title="5">  <span class="dt">effects =</span> <span class="st">&quot;includeRE&quot;</span>,</a>
<a class="sourceLine" id="cb28-6" title="6">  <span class="dt">CI =</span> <span class="fl">.95</span>,</a>
<a class="sourceLine" id="cb28-7" title="7">  <span class="dt">CIType =</span> <span class="st">&quot;ETI&quot;</span>)</a>
<a class="sourceLine" id="cb28-8" title="8"><span class="kw">data.frame</span>(bm<span class="op">$</span>ContrastSummary)</a>
<a class="sourceLine" id="cb28-9" title="9"><span class="co">#&gt;           M       Mdn         LL        UL PercentROPE PercentMID   CI CIType ROPE  MID Label</span></a>
<a class="sourceLine" id="cb28-10" title="10"><span class="co">#&gt; 1 0.1113512 0.1114643 0.08037199 0.1419889          NA         NA 0.95    ETI &lt;NA&gt; &lt;NA&gt; AME x</span></a>
<a class="sourceLine" id="cb28-11" title="11"></a>
<a class="sourceLine" id="cb28-12" title="12">mfx &lt;-<span class="st"> </span><span class="kw">marginaleffects</span>(mlogit)</a>
<a class="sourceLine" id="cb28-13" title="13"><span class="kw">summary</span>(mfx)</a>
<a class="sourceLine" id="cb28-14" title="14"><span class="co">#&gt; Average marginal effects </span></a>
<a class="sourceLine" id="cb28-15" title="15"><span class="co">#&gt;   Term Effect   2.5 % 97.5 %</span></a>
<a class="sourceLine" id="cb28-16" title="16"><span class="co">#&gt; 1    x 0.1114 0.08037  0.142</span></a>
<a class="sourceLine" id="cb28-17" title="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb28-18" title="18"><span class="co">#&gt; Model type:  brmsfit </span></a>
<a class="sourceLine" id="cb28-19" title="19"><span class="co">#&gt; Prediction type:  response</span></a></code></pre></div>
</div>
<div id="ame-fixed-effects-only-grand-mean" class="section level3">
<h3>AME: Fixed Effects Only (Grand Mean)</h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1">bm &lt;-<span class="st"> </span><span class="kw">brmsmargins</span>(</a>
<a class="sourceLine" id="cb29-2" title="2">  mlogit,</a>
<a class="sourceLine" id="cb29-3" title="3">  <span class="dt">add =</span> <span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">0</span>, h)),</a>
<a class="sourceLine" id="cb29-4" title="4">  <span class="dt">contrasts =</span> <span class="kw">cbind</span>(<span class="st">&quot;AME x&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>h, <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>h)),</a>
<a class="sourceLine" id="cb29-5" title="5">  <span class="dt">effects =</span> <span class="st">&quot;fixedonly&quot;</span>,</a>
<a class="sourceLine" id="cb29-6" title="6">  <span class="dt">CI =</span> <span class="fl">.95</span>,</a>
<a class="sourceLine" id="cb29-7" title="7">  <span class="dt">CIType =</span> <span class="st">&quot;ETI&quot;</span>)</a>
<a class="sourceLine" id="cb29-8" title="8"><span class="kw">data.frame</span>(bm<span class="op">$</span>ContrastSummary)</a>
<a class="sourceLine" id="cb29-9" title="9"><span class="co">#&gt;           M       Mdn         LL        UL PercentROPE PercentMID   CI CIType ROPE  MID Label</span></a>
<a class="sourceLine" id="cb29-10" title="10"><span class="co">#&gt; 1 0.1038071 0.1032705 0.06328158 0.1485747          NA         NA 0.95    ETI &lt;NA&gt; &lt;NA&gt; AME x</span></a>
<a class="sourceLine" id="cb29-11" title="11"></a>
<a class="sourceLine" id="cb29-12" title="12">mfx &lt;-<span class="st"> </span><span class="kw">marginaleffects</span>(mlogit, <span class="dt">re_formula =</span> <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb29-13" title="13"><span class="kw">summary</span>(mfx)</a>
<a class="sourceLine" id="cb29-14" title="14"><span class="co">#&gt; Average marginal effects </span></a>
<a class="sourceLine" id="cb29-15" title="15"><span class="co">#&gt;   Term Effect   2.5 % 97.5 %</span></a>
<a class="sourceLine" id="cb29-16" title="16"><span class="co">#&gt; 1    x 0.1038 0.06328 0.1486</span></a>
<a class="sourceLine" id="cb29-17" title="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb29-18" title="18"><span class="co">#&gt; Model type:  brmsfit </span></a>
<a class="sourceLine" id="cb29-19" title="19"><span class="co">#&gt; Prediction type:  response</span></a></code></pre></div>
</div>
</div>
<div id="marginal-effects-for-location-scale-models" class="section level2">
<h2>Marginal Effects for Location Scale Models</h2>
<div id="ames-for-fixed-effects-location-scale-models" class="section level3">
<h3>AMEs for Fixed Effects Location Scale Models</h3>
<p>Estimate a fixed effects location scale model with <code>brms</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1">d &lt;-<span class="st"> </span>withr<span class="op">::</span><span class="kw">with_seed</span>(</a>
<a class="sourceLine" id="cb30-2" title="2">  <span class="dt">seed =</span> <span class="dv">12345</span>, <span class="dt">code =</span> {</a>
<a class="sourceLine" id="cb30-3" title="3">    nObs &lt;-<span class="st"> </span>1000L</a>
<a class="sourceLine" id="cb30-4" title="4">    d &lt;-<span class="st"> </span><span class="kw">data.table</span>(</a>
<a class="sourceLine" id="cb30-5" title="5">      <span class="dt">grp =</span> <span class="kw">rep</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>, <span class="dt">each =</span> nObs <span class="op">/</span><span class="st"> </span>2L),</a>
<a class="sourceLine" id="cb30-6" title="6">      <span class="dt">x =</span> <span class="kw">rnorm</span>(nObs, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.25</span>))</a>
<a class="sourceLine" id="cb30-7" title="7">    d[, y <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">rnorm</span>(nObs,</a>
<a class="sourceLine" id="cb30-8" title="8">                   <span class="dt">mean =</span> x <span class="op">+</span><span class="st"> </span>grp,</a>
<a class="sourceLine" id="cb30-9" title="9">                   <span class="dt">sd =</span> <span class="kw">exp</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>grp))]</a>
<a class="sourceLine" id="cb30-10" title="10">    <span class="kw">copy</span>(d)</a>
<a class="sourceLine" id="cb30-11" title="11">  })</a>
<a class="sourceLine" id="cb30-12" title="12"></a>
<a class="sourceLine" id="cb30-13" title="13">void &lt;-<span class="st"> </span><span class="kw">capture.output</span>(</a>
<a class="sourceLine" id="cb30-14" title="14">    ls.fe &lt;-<span class="st"> </span><span class="kw">brm</span>(<span class="kw">bf</span>(</a>
<a class="sourceLine" id="cb30-15" title="15">      y <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>grp,</a>
<a class="sourceLine" id="cb30-16" title="16">      sigma <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>grp),</a>
<a class="sourceLine" id="cb30-17" title="17">      <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>,</a>
<a class="sourceLine" id="cb30-18" title="18">      <span class="dt">data =</span> d, <span class="dt">seed =</span> <span class="dv">1234</span>,</a>
<a class="sourceLine" id="cb30-19" title="19">      <span class="dt">silent =</span> <span class="dv">2</span>, <span class="dt">refresh =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb30-20" title="20">      <span class="dt">chains =</span> 4L, <span class="dt">cores =</span> 4L)</a>
<a class="sourceLine" id="cb30-21" title="21">)</a></code></pre></div>
</div>
<div id="fixed-effects-only" class="section level3">
<h3>Fixed effects only</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1">bm &lt;-<span class="st"> </span><span class="kw">brmsmargins</span>(</a>
<a class="sourceLine" id="cb31-2" title="2">  ls.fe,</a>
<a class="sourceLine" id="cb31-3" title="3">  <span class="dt">add =</span> <span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">0</span>, h)),</a>
<a class="sourceLine" id="cb31-4" title="4">  <span class="dt">contrasts =</span> <span class="kw">cbind</span>(<span class="st">&quot;AME x&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>h, <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>h)),</a>
<a class="sourceLine" id="cb31-5" title="5">  <span class="dt">CI =</span> <span class="fl">0.95</span>, <span class="dt">CIType =</span> <span class="st">&quot;ETI&quot;</span>,</a>
<a class="sourceLine" id="cb31-6" title="6">  <span class="dt">effects =</span> <span class="st">&quot;fixedonly&quot;</span>)</a>
<a class="sourceLine" id="cb31-7" title="7"><span class="kw">data.frame</span>(bm<span class="op">$</span>ContrastSummary)</a>
<a class="sourceLine" id="cb31-8" title="8"><span class="co">#&gt;          M     Mdn        LL       UL PercentROPE PercentMID   CI CIType ROPE  MID Label</span></a>
<a class="sourceLine" id="cb31-9" title="9"><span class="co">#&gt; 1 1.625042 1.63264 0.7558805 2.497346          NA         NA 0.95    ETI &lt;NA&gt; &lt;NA&gt; AME x</span></a>
<a class="sourceLine" id="cb31-10" title="10"></a>
<a class="sourceLine" id="cb31-11" title="11">mfx &lt;-<span class="st"> </span><span class="kw">marginaleffects</span>(ls.fe, <span class="dt">re_formula =</span> <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb31-12" title="12"><span class="kw">summary</span>(mfx)</a>
<a class="sourceLine" id="cb31-13" title="13"><span class="co">#&gt; Average marginal effects </span></a>
<a class="sourceLine" id="cb31-14" title="14"><span class="co">#&gt;   Term Effect  2.5 % 97.5 %</span></a>
<a class="sourceLine" id="cb31-15" title="15"><span class="co">#&gt; 1    x  1.625 0.7559  2.497</span></a>
<a class="sourceLine" id="cb31-16" title="16"><span class="co">#&gt; 2  grp  1.011 0.3482  1.678</span></a>
<a class="sourceLine" id="cb31-17" title="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb31-18" title="18"><span class="co">#&gt; Model type:  brmsfit </span></a>
<a class="sourceLine" id="cb31-19" title="19"><span class="co">#&gt; Prediction type:  response</span></a></code></pre></div>
</div>
<div id="discrete-change-and-distributional-parameter-dpar" class="section level3">
<h3>Discrete change and distributional parameter (<code>dpar</code>)</h3>
<p>Compute the contrast between adjusted predictions on the <code>sigma</code> parameter, when <code>grp=0</code> and <code>grp=1</code>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1">bm &lt;-<span class="st"> </span><span class="kw">brmsmargins</span>(</a>
<a class="sourceLine" id="cb32-2" title="2">  ls.fe,</a>
<a class="sourceLine" id="cb32-3" title="3">  <span class="dt">at =</span> <span class="kw">data.frame</span>(<span class="dt">grp =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)),</a>
<a class="sourceLine" id="cb32-4" title="4">  <span class="dt">contrasts =</span> <span class="kw">cbind</span>(<span class="st">&quot;AME grp&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)),</a>
<a class="sourceLine" id="cb32-5" title="5">  <span class="dt">CI =</span> <span class="fl">0.95</span>, <span class="dt">CIType =</span> <span class="st">&quot;ETI&quot;</span>, <span class="dt">dpar =</span> <span class="st">&quot;sigma&quot;</span>,</a>
<a class="sourceLine" id="cb32-6" title="6">  <span class="dt">effects =</span> <span class="st">&quot;fixedonly&quot;</span>)</a>
<a class="sourceLine" id="cb32-7" title="7"><span class="kw">data.frame</span>(bm<span class="op">$</span>ContrastSummary)</a>
<a class="sourceLine" id="cb32-8" title="8"><span class="co">#&gt;          M      Mdn       LL       UL PercentROPE PercentMID   CI CIType ROPE  MID   Label</span></a>
<a class="sourceLine" id="cb32-9" title="9"><span class="co">#&gt; 1 4.901384 4.895236 4.404996 5.417512          NA         NA 0.95    ETI &lt;NA&gt; &lt;NA&gt; AME grp</span></a></code></pre></div>
<p>In <code>marginaleffects</code> we use the <code>comparisons()</code> function and the <code>contrast_numeric</code> argument:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">cmp &lt;-<span class="st"> </span><span class="kw">comparisons</span>(</a>
<a class="sourceLine" id="cb33-2" title="2">  ls.fe,</a>
<a class="sourceLine" id="cb33-3" title="3">  <span class="dt">contrast_numeric =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb33-4" title="4">  <span class="dt">dpar =</span> <span class="st">&quot;sigma&quot;</span>)</a>
<a class="sourceLine" id="cb33-5" title="5"><span class="kw">summary</span>(cmp)</a>
<a class="sourceLine" id="cb33-6" title="6"><span class="co">#&gt; Average contrasts </span></a>
<a class="sourceLine" id="cb33-7" title="7"><span class="co">#&gt;                 Group Term Contrast Effect 2.5 % 97.5 %</span></a>
<a class="sourceLine" id="cb33-8" title="8"><span class="co">#&gt; 1 main_marginaleffect    x    1 - 0  6.850 4.918  9.076</span></a>
<a class="sourceLine" id="cb33-9" title="9"><span class="co">#&gt; 2 main_marginaleffect  grp    1 - 0  4.901 4.405  5.418</span></a>
<a class="sourceLine" id="cb33-10" title="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb33-11" title="11"><span class="co">#&gt; Model type:  brmsfit </span></a>
<a class="sourceLine" id="cb33-12" title="12"><span class="co">#&gt; Prediction type:  response</span></a></code></pre></div>
</div>
<div id="marginal-effect-continuous-on-sigma" class="section level3">
<h3>Marginal effect (continuous) on sigma</h3>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1">bm &lt;-<span class="st"> </span><span class="kw">brmsmargins</span>(</a>
<a class="sourceLine" id="cb34-2" title="2">  ls.fe,</a>
<a class="sourceLine" id="cb34-3" title="3">  <span class="dt">add =</span> <span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">0</span>, h)),</a>
<a class="sourceLine" id="cb34-4" title="4">  <span class="dt">contrasts =</span> <span class="kw">cbind</span>(<span class="st">&quot;AME x&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>h, <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>h)),</a>
<a class="sourceLine" id="cb34-5" title="5">  <span class="dt">CI =</span> <span class="fl">0.95</span>, <span class="dt">CIType =</span> <span class="st">&quot;ETI&quot;</span>, <span class="dt">dpar =</span> <span class="st">&quot;sigma&quot;</span>,</a>
<a class="sourceLine" id="cb34-6" title="6">  <span class="dt">effects =</span> <span class="st">&quot;fixedonly&quot;</span>)</a>
<a class="sourceLine" id="cb34-7" title="7"><span class="kw">data.frame</span>(bm<span class="op">$</span>ContrastSummary)</a>
<a class="sourceLine" id="cb34-8" title="8"><span class="co">#&gt;          M      Mdn       LL       UL PercentROPE PercentMID   CI CIType ROPE  MID Label</span></a>
<a class="sourceLine" id="cb34-9" title="9"><span class="co">#&gt; 1 4.455297 4.443977 3.500513 5.449401          NA         NA 0.95    ETI &lt;NA&gt; &lt;NA&gt; AME x</span></a>
<a class="sourceLine" id="cb34-10" title="10"></a>
<a class="sourceLine" id="cb34-11" title="11">mfx &lt;-<span class="st"> </span><span class="kw">marginaleffects</span>(ls.fe, <span class="dt">dpar =</span> <span class="st">&quot;sigma&quot;</span>, <span class="dt">re_formula =</span> <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb34-12" title="12"><span class="kw">summary</span>(mfx)</a>
<a class="sourceLine" id="cb34-13" title="13"><span class="co">#&gt; Average marginal effects </span></a>
<a class="sourceLine" id="cb34-14" title="14"><span class="co">#&gt;   Term Effect 2.5 % 97.5 %</span></a>
<a class="sourceLine" id="cb34-15" title="15"><span class="co">#&gt; 1    x  4.455 3.501  5.449</span></a>
<a class="sourceLine" id="cb34-16" title="16"><span class="co">#&gt; 2  grp  5.293 4.694  5.926</span></a>
<a class="sourceLine" id="cb34-17" title="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb34-18" title="18"><span class="co">#&gt; Model type:  brmsfit </span></a>
<a class="sourceLine" id="cb34-19" title="19"><span class="co">#&gt; Prediction type:  response</span></a></code></pre></div>
</div>
</div>
</div>
<div id="effects" class="section level1">
<h1><code>effects</code></h1>
<p>The <a href="https://cran.r-project.org/eb/packages/effects/index.html"><code>effects</code> package</a> was created by John Fox and colleagues.</p>
<ul>
<li><code>marginaleffects</code> supports 30+ more model types than <code>effects</code>.</li>
<li><code>effects</code> focuses on the computation of <a href="https://vincentarelbundock.github.io/marginaleffects/articles/mfx01_predictions.html">“adjusted predictions.”</a> The plots it produces are roughly equivalent to the ones produced by the <code>plot_cap</code> and <code>predictions</code> functions in <code>marginaleffects</code>.</li>
<li><code>effects</code> does not appear support marginal effects (slopes), marginal means, or contrasts</li>
<li><code>effects</code> uses Base graphics whereas <code>marginaleffects</code> uses <code>ggplot2</code></li>
<li><code>effects</code> includes <em>a lot</em> of very powerful options to customize plots. In contrast, <code>marginaleffects</code> produces objects which can be customized by chaining <code>ggplot2</code> functions. Users can also call <code>plot_cap(model, draw=FALSE)</code> to create a prediction grid, and then work the raw data directly to create the plot they need</li>
</ul>
<p><code>effects</code> offers several options which are not currently available in <code>marginaleffects</code>, including:</p>
<ul>
<li>Partial residuals plots</li>
<li>Many types of ways to plot adjusted predictions: <a href="https://cran.r-project.org/web/packages/effects/vignettes/predictor-effects-gallery.pdf">package vignette</a></li>
</ul>
</div>
<div id="modelbased" class="section level1">
<h1><code>modelbased</code></h1>
<p>The <a href="https://easystats.github.io/modelbased/"><code>modelbased</code> package</a> is developed by the <code>easystats</code> team.</p>
<p>This section is incomplete; contributions are welcome.</p>
<ul>
<li>Wrapper around <code>emmeans</code> to compute marginal means and marginal effects.</li>
<li>Powerful functions to create beautiful plots.</li>
</ul>
</div>
<div id="ggeffects" class="section level1">
<h1><code>ggeffects</code></h1>
<p>The <a href="https://strengejacke.github.io/ggeffects/"><code>ggeffects</code></a> package is developed by Daniel Lüdecke.</p>
<p>This section is incomplete; contributions are welcome.</p>
<ul>
<li>Wrapper around <code>emmeans</code> to compute marginal means.</li>
</ul>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
